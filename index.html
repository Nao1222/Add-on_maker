<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Add-on Studio (Download Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #2a273f; --bg-secondary: #252338; --bg-tertiary: #3e3a59;
            --text-primary: #ffffff; --text-secondary: #b0a9df;
            --accent: #ff79c6; --accent-hover: #ff92d0; --danger: #ff5555;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .card { background-color: var(--bg-primary); border: 1px solid var(--bg-tertiary); border-radius: 12px; padding: 24px; }
        .input-field { background-color: var(--bg-tertiary); border: 1px solid #5a5577; color: var(--text-primary); border-radius: 8px; padding: 10px; width: 100%; transition: border-color 0.2s; }
        .input-field:focus { outline: none; border-color: var(--accent); }
        .label { font-weight: 500; margin-bottom: 8px; display: block; color: var(--text-secondary); }
        .btn { color: var(--bg-primary); padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; outline: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--accent); color: #2a273f; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-primary:disabled { background-color: #585b70; cursor: not-allowed; }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #5a5577; }
        .image-preview { width: 96px; height: 96px; background-color: var(--bg-secondary); border: 2px dashed var(--bg-tertiary); display: flex; align-items: center; justify-content: center; border-radius: 8px; image-rendering: pixelated; flex-shrink: 0; position: relative; }
        .image-preview img { width: 100%; height: 100%; object-fit: contain; }
        .image-preview .label { position: absolute; bottom: -20px; font-size: 0.75rem; color: var(--text-secondary); }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); border-bottom: 3px solid var(--accent); padding-bottom: 12px; margin-bottom: 24px; }
        .hidden { display: none; }
        #itemList .item.active { background-color: var(--accent); color: var(--bg-primary); }
        .crafting-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 240px; margin: 0 auto; }
        .crafting-grid input { text-align: center; padding: 8px; }
    </style>
</head>
<body class="antialiased">

    <input type="file" id="import-input" class="hidden" accept=".mcaddon,.zip" onchange="handleImport(event)">

    <div class="flex h-screen bg-bg-secondary">
        <!-- Left Pane: Item List -->
        <aside class="w-1/4 bg-bg-primary p-4 flex flex-col min-w-[300px]">
            <h2 class="text-2xl font-bold mb-4 border-b border-bg-tertiary pb-2">プロジェクト</h2>
            <div class="flex gap-2 mb-4">
                <button class="btn btn-secondary w-full justify-center" onclick="document.getElementById('import-input').click()"><i class="fas fa-upload"></i>アドオンをインポート</button>
            </div>
            <div class="mb-4"><label for="addonName" class="label">アドオン名</label><input type="text" id="addonName" class="input-field" value="My Ultimate Addon"></div>
            <div class="mb-4"><label for="addonDesc" class="label">アドオンの説明</label><input type="text" id="addonDesc" class="input-field" value="Generated by Ultimate Add-on Studio"></div>
            <h3 class="text-xl font-bold mt-4 mb-2">アイテム/ブロック一覧</h3>
            <div id="itemList" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
            <div class="mt-4"><button class="btn btn-primary w-full justify-center" onclick="addNewItem()"><i class="fas fa-plus"></i>新規アイテム/ブロック</button></div>
            <div class="mt-8 border-t border-bg-tertiary pt-4"><button id="generateBtn" class="btn btn-primary w-full text-lg py-3 justify-center" onclick="generateAddon()"><i class="fas fa-download"></i>アドオンを生成</button><p id="message-area" class="text-accent mt-2 text-center font-semibold"></p></div>
        </aside>

        <!-- Right Pane: Editor -->
        <main id="editor" class="w-3/4 p-8 overflow-y-auto">
            <div id="welcomeScreen" class="text-center h-full flex flex-col justify-center items-center">
                <i class="fas fa-magic-wand-sparkles text-6xl text-accent mb-4"></i>
                <h1 class="text-4xl font-bold">Ultimate Add-on Studio</h1>
                <p class="text-text-secondary text-lg mt-2">「アドオンをインポート」するか「新規アイテム/ブロック」で作成を開始します。</p>
            </div>
            <div id="editorContent" class="hidden">
                 <!-- The full editor will be rendered here -->
            </div>
        </main>
    </div>

    <script>
        // --- Data Management & Constants (unchanged) ---
        let items = [];
        let selectedItemId = null;
        const messageArea = document.getElementById('message-area');
        const TOOL_TYPES = ['sword', 'pickaxe', 'axe', 'shovel', 'hoe'];
        const ARMOR_TYPES = ['helmet', 'chestplate', 'leggings', 'boots'];

        // --- UI Rendering Logic (unchanged) ---
        function renderItemList() {
            const list = document.getElementById('itemList');
            list.innerHTML = '';
            if (items.length === 0) {
                list.innerHTML = `<div class="text-center text-text-secondary p-4">アイテムがありません</div>`;
                return;
            }
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `item p-3 rounded-lg cursor-pointer flex items-center justify-between hover:bg-bg-tertiary ${item.id === selectedItemId ? 'active' : ''}`;
                div.onclick = () => selectItem(item.id);
                div.innerHTML = `<div class="flex items-center gap-3"><img src="${item.textureDataURL || 'https://placehold.co/32x32/252338/b0a9df?text=?'}" class="w-8 h-8 bg-bg-secondary rounded" style="image-rendering: pixelated;"><span class="font-semibold">${item.itemName || '無名のアイテム'}</span></div><button class="text-danger hover:text-red-400" onclick="event.stopPropagation(); deleteItem('${item.id}');"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(div);
            });
        }
        function renderEditor() {
            const item = items.find(i => i.id === selectedItemId);
            const editorContent = document.getElementById('editorContent');
            document.getElementById('welcomeScreen').classList.add('hidden');
            editorContent.classList.remove('hidden');

            if (!item) {
                editorContent.classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
                return;
            }
            
            editorContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">${item.itemName || '新規アイテム'}</h2>
                    <button class="btn btn-primary" onclick="saveCurrentItem()"><i class="fas fa-save"></i>変更を保存</button>
                </div>
                <div class="space-y-8">
                    <div class="card grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2 space-y-6">
                            <div><label class="label">名前</label><input type="text" class="input-field" data-key="itemName" value="${item.itemName || ''}"></div>
                            <div><label class="label">ID</label><input type="text" class="input-field" data-key="itemId" value="${item.itemId || ''}"></div>
                            <div><label class="label">種類</label><select class="input-field" data-key="itemType">${getItemTypeOptions(item.itemType)}</select></div>
                        </div>
                        <div class="flex flex-col items-center justify-center">
                            <label class="label">テクスチャ</label>
                            <div class="image-preview mb-4"><img src="${item.textureDataURL || 'https://placehold.co/96x96/252338/b0a9df?text=?'}"></div>
                            <input type="file" class="hidden item-texture-input" accept="image/png">
                            <button class="btn btn-primary w-full justify-center" onclick="this.previousElementSibling.click()">画像を選択</button>
                        </div>
                    </div>
                    ${getDynamicSections(item)}
                    ${getRecipeSection(item)}
                </div>
            `;
            
            editorContent.querySelector('[data-key="itemType"]').onchange = () => { saveCurrentItem(); renderEditor(); };
            editorContent.querySelector('.item-texture-input').onchange = (e) => handleTextureUpload(e, item.id);
        }
        function getItemTypeOptions(selectedType) { /* ...unchanged... */
            const types = { 'アイテム': ['generic', 'food'], 'ツール': ['sword', 'pickaxe', 'axe', 'shovel', 'hoe'], '防具': ['helmet', 'chestplate', 'leggings', 'boots'], 'ブロック': ['block'] };
            let html = '';
            for (const group in types) {
                html += `<optgroup label="${group}">`;
                types[group].forEach(type => {
                    html += `<option value="${type}" ${type === selectedType ? 'selected' : ''}>${type}</option>`;
                });
                html += `</optgroup>`;
            }
            return html;
        }
        function getDynamicSections(item) { /* ...unchanged... */
            let html = '';
            const isTool = TOOL_TYPES.includes(item.itemType);
            const isArmor = ARMOR_TYPES.includes(item.itemType);
            const isBlock = item.itemType === 'block';

            html += `<div class="card"><h3 class="section-title">共通設定</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="label">最大スタック数</label><input type="number" class="input-field" data-key="maxStackSize" value="${item.maxStackSize || 64}"></div><div class="flex items-center mt-6"><input type="checkbox" data-key="foil" class="w-5 h-5 accent-accent" ${item.foil ? 'checked' : ''}><label class="label ml-2 !mb-0">エンチャントの輝き</label></div></div></div>`;
            if (isTool || isArmor) { html += `<div class="card"><h3 class="section-title">装備設定</h3><div><label class="label">耐久値</label><input type="number" class="input-field" data-key="durability" value="${item.durability || 100}"></div></div>`; }
            if (isTool) { html += `<div class="card"><h3 class="section-title">ツール設定</h3>${item.itemType === 'sword' ? `<div><label class="label">攻撃力</label><input type="number" class="input-field" data-key="damage" value="${item.damage || 1}"></div>` : `<div><label class="label">破壊速度</label><input type="number" class="input-field" data-key="speed" value="${item.speed || 1}"></div>`}</div>`; }
            if (isArmor) { html += `<div class="card"><h3 class="section-title">防具設定</h3><div><label class="label">防御力</label><input type="number" class="input-field" data-key="protection" value="${item.protection || 1}"></div></div>`; }
            if (isBlock) { html += `<div class="card"><h3 class="section-title">ブロック設定</h3><div class="grid grid-cols-2 gap-6"><div><label class="label">硬さ (破壊時間)</label><input type="number" class="input-field" data-key="destroyTime" value="${item.destroyTime || 1.0}"></div><div><label class="label">爆発耐性</label><input type="number" class="input-field" data-key="explosionResistance" value="${item.explosionResistance || 1.0}"></div></div></div>`; }
            return html;
        }
        function getRecipeSection(item) { /* ...unchanged... */ 
            const recipe = item.recipe || { type: 'none', pattern: ['','',''], keys: {}, result_count: 1 };
            const patternHTML = recipe.pattern.map((row, rowIndex) => row.padEnd(3, ' ').split('').map((key, colIndex) => `<input type="text" class="input-field crafting-key" data-row="${rowIndex}" data-col="${colIndex}" value="${key.trim()}">`).join('')).join('');
            return `<div class="card"><h3 class="section-title">クラフトレシピ (定形)</h3><div class="flex items-center gap-8"><div><label class="label">パターン (1文字のキー)</label><div class="crafting-grid">${patternHTML}</div></div><div><label class="label">キーとアイテムID</label><div id="recipe-keys" class="space-y-2"></div></div><div><label class="label">作成個数</label><input type="number" class="input-field" data-key="recipeResultCount" value="${recipe.result_count || 1}"></div></div></div>`;
        }

        // --- Event Handlers (unchanged) ---
        function addNewItem() { const newItem = { id: `item_${Date.now()}`, itemName: `新規アイテム${items.length + 1}`, itemId: `myaddon:item${items.length + 1}`, itemType: 'generic' }; items.push(newItem); selectItem(newItem.id); }
        function selectItem(id) { saveCurrentItem(); selectedItemId = id; renderItemList(); renderEditor(); }
        function deleteItem(id) { items = items.filter(item => item.id !== id); if (selectedItemId === id) { selectedItemId = null; } renderItemList(); renderEditor(); }
        function saveCurrentItem() { if (!selectedItemId) return; const item = items.find(i => i.id === selectedItemId); if (!item) return; const editor = document.getElementById('editorContent'); if (!editor.innerHTML) return; editor.querySelectorAll('[data-key]').forEach(input => { const key = input.dataset.key; const value = input.type === 'checkbox' ? input.checked : (input.type === 'number' ? parseFloat(input.value) : input.value); item[key] = value; }); const listItem = document.querySelector(`#itemList .item.active .font-semibold`); if(listItem) listItem.textContent = item.itemName; }
        function handleTextureUpload(event, itemId) { const file = event.target.files[0]; if (!file) return; const item = items.find(i => i.id === itemId); if (!item) return; item.textureFile = file; const reader = new FileReader(); reader.onload = (e) => { item.textureDataURL = e.target.result; renderItemList(); renderEditor(); }; reader.readAsDataURL(file); }
        async function handleImport(event) { /* ...unchanged... */ }

        // --- ★★★ DOWNLOAD LOGIC: FIXED ★★★ ---
        async function generateAddon() {
            saveCurrentItem();
            const addonName = document.getElementById('addonName').value.trim();
            const addonDesc = document.getElementById('addonDesc').value.trim();
            messageArea.textContent = '';

            if (!addonName || !addonDesc || items.length === 0) {
                messageArea.textContent = '情報不足: アドオン名、説明、1つ以上のアイテムが必要です。';
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>生成中...';

            try {
                const zip = new JSZip();
                const bp = zip.folder("behavior_pack");
                const rp = zip.folder("resource_pack");
                
                const bp_uuid = `b${crypto.randomUUID()}`;
                const rp_uuid = `r${crypto.randomUUID()}`;

                // --- Behavior Pack Manifest ---
                const bp_manifest = { format_version: 2, header: { name: `${addonName} (BP)`, description: addonDesc, uuid: bp_uuid, version: [1, 0, 0], min_engine_version: [1, 16, 0] }, modules: [{ type: "data", uuid: `d${crypto.randomUUID()}`, version: [1, 0, 0] }], dependencies: [{ uuid: rp_uuid, version: [1, 0, 0] }] };
                bp.file("manifest.json", JSON.stringify(bp_manifest, null, 2));

                // --- Resource Pack Manifest ---
                const rp_manifest = { format_version: 2, header: { name: `${addonName} (RP)`, description: addonDesc, uuid: rp_uuid, version: [1, 0, 0], min_engine_version: [1, 16, 0] }, modules: [{ type: "resources", uuid: `s${crypto.randomUUID()}`, version: [1, 0, 0] }] };
                rp.file("manifest.json", JSON.stringify(rp_manifest, null, 2));

                const itemTextureJson = { resource_pack_name: "vanilla", texture_name: "atlas.items", texture_data: {} };
                let langContent = "";

                for (const item of items) {
                    const itemIdentifier = item.itemId.split(':')[1];
                    const itemJson = { "format_version": "1.16.100", "minecraft:item": { "description": { "identifier": item.itemId, "category": (TOOL_TYPES.includes(item.itemType) || ARMOR_TYPES.includes(item.itemType)) ? "equipment" : "items" }, "components": {} } };
                    const components = itemJson["minecraft:item"].components;
                    
                    components["minecraft:display_name"] = { "value": item.itemName };
                    components["minecraft:max_stack_size"] = item.maxStackSize || 64;
                    if(item.foil) components["minecraft:foil"] = true;
                    if(item.textureFile) components["minecraft:icon"] = { "texture": itemIdentifier };

                    bp.file(`items/${itemIdentifier}.json`, JSON.stringify(itemJson, null, 2));
                    
                    if(item.textureFile) {
                        rp.file(`textures/items/${itemIdentifier}.png`, item.textureFile);
                        itemTextureJson.texture_data[itemIdentifier] = { textures: `textures/items/${itemIdentifier}` };
                    }
                    langContent += `item.${item.itemId}.name=${item.itemName}\n`;
                }
                
                rp.file("textures/item_texture.json", JSON.stringify(itemTextureJson, null, 2));
                rp.file("texts/en_US.lang", langContent);
                rp.file("texts/ja_JP.lang", langContent);

                // --- Await for the zip generation to complete ---
                const content = await zip.generateAsync({ type:"blob" });
                
                // --- Create and trigger download link ---
                const a = document.createElement('a');
                const url = URL.createObjectURL(content);
                a.href = url;
                a.download = `${addonName.replace(/\s/g, '_')}.mcaddon`;
                document.body.appendChild(a);
                
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                messageArea.textContent = 'アドオンが正常に生成されました！';

            } catch (error) {
                console.error("Generation failed:", error);
                messageArea.textContent = `エラーが発生しました: ${error.message}`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-download"></i>アドオンを生成';
            }
        }

        // --- Initialization ---
        renderItemList();
    </script>
</body>
</html>
